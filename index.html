<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>VK Photo Map</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://api-maps.yandex.ru/2.1/?lang=en_RU" type="text/javascript"></script>
     <script src="js/scripts.js"></script>
</head>
<body>

    <header>
        <h1>VK Photo Map</h1>
       <div id="profileInfo" style="display: none;">
        <span id="profileName"></span>
        <button onclick="logout()">Logout</button>
    </div>
    </header>


<div>
  <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
  <script type="text/javascript">
    if ('VKIDSDK' in window) {
      const VKID = window.VKIDSDK;

      // Генерация codeVerifier и codeChallenge
      function generateCodeVerifier() {
        const array = new Uint8Array(32);
        window.crypto.getRandomValues(array);
        return Array.from(array, byte => ('0' + byte.toString(16)).slice(-2)).join('');
      }

      async function generateCodeChallenge(verifier) {
        const encoder = new TextEncoder();
        const data = encoder.encode(verifier);
        const digest = await window.crypto.subtle.digest('SHA-256', data);
        return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      const codeVerifier = generateCodeVerifier();
      generateCodeChallenge(codeVerifier).then(codeChallenge => {
        VKID.Config.init({
          app: 52496362,
          redirectUrl: 'https://g3737.github.io',
          responseMode: VKID.ConfigResponseMode.Callback,
          source: VKID.ConfigSource.LOWCODE,
          codeChallenge: codeChallenge,
          codeChallengeMethod: 'S256'
        });

        const floatingOneTap = new VKID.FloatingOneTap();

        floatingOneTap.render({
          scheme: 'dark',
          appName: 'geomap',
          showAlternativeLogin: true
        })
        .on(VKID.WidgetEvents.ERROR, vkidOnError)
        .on(VKID.FloatingOneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
          const code = payload.code;
          const deviceId = payload.device_id;

          VKID.Auth.exchangeCode(code, deviceId, { codeVerifier })
            .then(vkidOnSuccess)
            .catch(vkidOnError);
        });
      });
    
      function vkidOnSuccess(data) {
        floatingOneTap.close();
        const { access_token, user_id } = data;

        fetch(`https://api.vk.com/method/users.get?user_ids=${user_id}&access_token=${access_token}&v=5.131`)
          .then(response => response.json())
          .then(result => {
            if (result.response && result.response.length > 0) {
              const userName = `${result.response[0].first_name} ${result.response[0].last_name}`;
              displayUserProfile(userName, access_token);
            }
          })
          .catch(error => console.error('Ошибка при получении данных пользователя:', error));
      }
    
      function vkidOnError(error) {
        console.error("Ошибка авторизации VKID:", error);
      }

      function displayUserProfile(name, accessToken) {
        const profileSection = document.createElement('div');
        profileSection.innerHTML = `
          <p>Привет, ${name}!</p>
          <button onclick="logout('${accessToken}')">Выйти</button>
        `;
        document.body.prepend(profileSection);
      }

      function logout(accessToken) {
        VKID.Auth.logout(accessToken)
          .then(() => {
            location.reload();
          })
          .catch(error => console.error('Ошибка при выходе из аккаунта:', error));
      }
    }
  </script>
</div>



    <section id="map-section">
        <div id="map"></div>
    </section>

    <section id="search-form">
    <form id="searchForm" autocomplete="off">
        <input type="text" id="address" placeholder="Enter street name">
        <input type="text" id="vkID" placeholder="Search by VK ID">

        <select id="ageFilter">
            <option value="">Select Age</option>
            <option value="18-25">18-25</option>
            <option value="26-35">26-35</option>
            <option value="36-50">36-50</option>
        </select>

        <select id="genderFilter">
            <option value="">Select Gender</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
        </select>

        <input type="text" id="interestFilter" placeholder="Interests (e.g., travel, sports)">
        <input type="text" id="communityFilter" placeholder="Community (e.g., group ID)">
        <input type="number" id="friendsFilter" placeholder="Number of friends (e.g., >100)">

        <!-- Установка радиуса по умолчанию в 100 метров (0.1 км) -->
        <input type="number" id="radiusFilter" placeholder="Radius (m)" min="1" value="100">

        <!-- Выбор диапазона дат -->
        <input type="date" id="startDate" placeholder="Start Date">
        <input type="date" id="endDate" placeholder="End Date">

        <button type="button" onclick="applyFilters()">Search</button>
    </form>
</section>

   <section id="gallery">
    <h2>Gallery of Photos</h2>
    <div id="photoGallery" class="photo-grid"></div>
    <div id="paginationControls">
        <button id="prevPage" onclick="changePage(-1)">Previous</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage" onclick="changePage(1)">Next</button>
    </div>
</section>

    <div id="vkProfileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="vkProfileDetails"></div>
        </div>
    </div>

   
</body>
</html>
